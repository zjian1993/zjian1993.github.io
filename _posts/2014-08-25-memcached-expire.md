---
layout: post
title:  "memcached缓存失效时的高并发访问问题解决"
date:   2014-08-25 20:20:00
categories:
- Notes
tags:
- memcached
- Database
---

之前在一篇[博文](http://blog.sina.com.cn/s/blog_539d361e0100nc9h.html)上看到了关于对memcached的缓存失效的那一时间点可能迎来的高并发访问的处理方法。但是这篇博文只提到了在key失效之后的处理方式，这样做有个很明显的缺点，就是当第一个访问进行对数据库的读取时，其他的进程都需要等待第一个进程，直到他从数据库中读取到值并且set，其实还可以在key失效前就进行处理。  
对于每一个key，都有一个有效时间，假设有效时间未30s，前面的博文就是在30s到期时进行的处理，但是我们可以设置一个假的有效时间，如25秒。那么，在每次从缓存中取值的时候还要判断距离key的到期时间还有多久，如果距离key的到期时间大于5秒，那么就直接取key对应的value，不做其他处理。但是如果距离key的到期时间小于5s并且这个key还没有真正到期，那么这时我们可以再用前面博文中的方法，让第一个访问的客户端重新从数据库中读取数据并且set，此时还要给其加锁，然后别的访问对于key的请求，则让他们依旧取原来的缓存中的key对应的value值。这样，就能避免其他的进程的不必要的等待了。








